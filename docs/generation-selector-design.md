# ポケモン世代選択機能 拡張設計書（ポップアップボタン版）

## 概要
ポケモン図鑑の世代選択機能を拡張し、第1世代から第9世代までのポケモンをポップアップボタンで切り替えて表示できるようにする。

## APIテスト結果
全ての世代でポケモン情報が正常に取得できることを確認済み：
- ✓ 第7世代: ID 722 (モクロー) 〜 809 (メルメタル)
- ✓ 第8世代: ID 810 (サルノリ) 〜 905 (レジドラゴ)
- ✓ 第9世代: ID 906 (ニャオハ) 〜 1025 (ペラップ)

## 要件

### 機能要件
- 第1世代（1-151）、第2世代（152-251）、第3世代（252-386）、第4世代（387-493）、第5世代（494-649）、第6世代（650-721）、第7世代（722-809）、第8世代（810-905）、第9世代（906-1025）のポケモンをAPIから取得
- **ポップアップボタン**で世代選択UIを実装
- 選択ボタンを押すことで世代の切り替えが可能
- 世代切り替え時は、選択した世代のポケモンのみを表示
- 検索機能も選択中の世代のポケモンのみを対象とする
- 出力状態（表示形式）は変更なし

### UI/UX要件
- 世代選択はポップアップボタン（ポップオーバー）で実装（「第1世代」〜「第9世代」）
- ボタンをクリックするとポップアップが表示され、全世代の選択肢がグリッド形式で表示される
- 選択中の世代には視覚的な区別を表示（背景色）
- 世代切り替え時は選択中のポケモンをリセットし、新しい世代の最初のポケモンを表示
- ローディング状態を表示
- レスポンシブ対応

### 非機能要件
- **テストは厳格に**: 世代切り替え時に他の世代のポケモンが混ざらないように取得・表示
- パフォーマンス: 世代切り替え時のローディングは最小限に
- データの一貫性: 世代ごとに完全にデータをクリアして再取得

## 技術設計

### ポケモン世代の定義

```typescript
type Generation = 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 | 9;

const GENERATION_CONFIG = {
  1: {
    label: "第1世代",
    startId: 1,
    endId: 151,
    count: 151,
  },
  2: {
    label: "第2世代",
    startId: 152,
    endId: 251,
    count: 100,
  },
  3: {
    label: "第3世代",
    startId: 252,
    endId: 386,
    count: 135,
  },
  4: {
    label: "第4世代",
    startId: 387,
    endId: 493,
    count: 107,
  },
  5: {
    label: "第5世代",
    startId: 494,
    endId: 649,
    count: 156,
  },
  6: {
    label: "第6世代",
    startId: 650,
    endId: 721,
    count: 72,
  },
  7: {
    label: "第7世代",
    startId: 722,
    endId: 809,
    count: 88,
  },
  8: {
    label: "第8世代",
    startId: 810,
    endId: 905,
    count: 96,
  },
  9: {
    label: "第9世代",
    startId: 906,
    endId: 1025,
    count: 120,
  },
} as const;
```

### ポップアップボタンの設計

ポップアップボタン（ポップオーバー）は、以下の特徴を持つUIコンポーネント：
- 超省スペース：9つの選択肢を最小限のスペースで提供
- トリガーボタンに現在の世代を表示
- クリックでポップアップが開き、全世代がグリッド形式で表示される
- プルダウンよりも視認性が高く、一覧性に優れる
- レスポンシブで使いやすい

#### ポップアップボタンのスタイル仕様

**トリガーボタン**:
- 背景: 白（bg-white）
- ボーダー: グレー（border border-gray-300）
- パディング: px-4 py-2
- 角丸: rounded-lg
- アイコン: LayoutGrid（グリッドアイコン）
- ホバー時: 軽いグレー背景

**ポップアップ**:
- 背景: 白（bg-white）
- シャドウ: shadow-xl
- ボーダー: border border-gray-200
- 角丸: rounded-lg
- 幅: w-80（320px）
- パディング: p-4

**グリッド**:
- レイアウト: 3列のグリッド（grid grid-cols-3 gap-2）
- 各世代ボタン: px-3 py-2 rounded-md

**世代ボタン（非選択時）**:
- 背景: グレー（bg-gray-100）
- 文字色: グレー（text-gray-700）
- ホバー時: bg-gray-200

**世代ボタン（選択時）**:
- 背景: 青（bg-blue-500）
- 文字色: 白（text-white）
- シャドウ: shadow-sm

### UI構造

```
ModernPokedex
├── Header
│   ├── Popover（世代選択）
│   │   ├── Trigger Button（現在選択中の世代を表示）
│   │   └── Popup Content
│   │       └── Grid (3列)
│   │           ├── Button "第1世代"
│   │           ├── Button "第2世代"
│   │           ├── Button "第3世代"
│   │           ├── Button "第4世代"
│   │           ├── Button "第5世代"
│   │           ├── Button "第6世代"
│   │           ├── Button "第7世代"
│   │           ├── Button "第8世代"
│   │           └── Button "第9世代"
│   └── Search Icon Button
├── SearchModal（世代対応）
└── Main Content
```

### 実装ファイル

#### 修正
- `src/app/page.tsx`:
  - `Generation` 型を `1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 | 9` に拡張
  - `GENERATION_CONFIG` に第7世代、第8世代、第9世代を追加
  - プルダウンをポップアップボタンに置き換え

#### 新規作成
- なし（既存コンポーネントの修正のみ、シンプルなポップアップを実装）

### ヘッダーレイアウト

**修正前（プルダウン）**:
```
┌──────────────────────────────────────────┐
│ [第1世代 ▼]                       [🔍] │
└──────────────────────────────────────────┘
```

**修正後（ポップアップ）**:
```
┌──────────────────────────────────────────┐
│ [第1世代 ⊞]                       [🔍] │
└──────────────────────────────────────────┘
     │
     └─ ┌─────────────────────────┐
        │ 第1世代  第2世代  第3世代 │
        │ 第4世代  第5世代  第6世代 │
        │ 第7世代  第8世代  第9世代 │
        └─────────────────────────┘
```

## 実装コード

### ポップアップボタンの実装（page.tsx内）

```tsx
{/* ポップアップボタン - 世代選択 */}
<div className="relative">
  <button
    onClick={() => setIsPopupOpen(!isPopupOpen)}
    className="flex items-center gap-2 px-4 py-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors"
  >
    <span className="font-medium">{GENERATION_CONFIG[currentGeneration].label}</span>
    <LayoutGrid className="w-4 h-4 text-gray-600" />
  </button>

  {isPopupOpen && (
    <>
      {/* オーバーレイ */}
      <div
        className="fixed inset-0 z-10"
        onClick={() => setIsPopupOpen(false)}
      />

      {/* ポップアップ */}
      <div className="absolute left-0 top-full mt-2 z-20 bg-white border border-gray-200 rounded-lg shadow-xl w-80 p-4">
        <h3 className="text-sm font-semibold text-gray-700 mb-3">世代を選択</h3>

        {/* グリッド */}
        <div className="grid grid-cols-3 gap-2">
          {([1, 2, 3, 4, 5, 6, 7, 8, 9] as const).map((gen) => (
            <button
              key={gen}
              onClick={() => {
                handleGenerationChange(gen);
                setIsPopupOpen(false);
              }}
              className={`px-3 py-2 rounded-md font-medium transition-all text-center ${
                currentGeneration === gen
                  ? "bg-blue-500 text-white shadow-sm"
                  : "bg-gray-100 text-gray-700 hover:bg-gray-200"
              }`}
            >
              {GENERATION_CONFIG[gen].label}
            </button>
          ))}
        </div>
      </div>
    </>
  )}
</div>
```

## テスト方針

### 厳格なテスト項目

1. **世代の分離**
   - 第1世代選択時: ID 1-151 のみ表示
   - 第2世代選択時: ID 152-251 のみ表示
   - 第3世代選択時: ID 252-386 のみ表示
   - 第4世代選択時: ID 387-493 のみ表示
   - 第5世代選択時: ID 494-649 のみ表示
   - 第6世代選択時: ID 650-721 のみ表示
   - 第7世代選択時: ID 722-809 のみ表示
   - 第8世代選択時: ID 810-905 のみ表示
   - 第9世代選択時: ID 906-1025 のみ表示
   - 世代切り替え時に前の世代のデータが残らない

2. **データの一貫性**
   - リストに表示されるポケモンは全て選択中の世代
   - 検索結果も選択中の世代のポケモンのみ
   - 「もっと見る」で追加されるポケモンも選択中の世代

3. **境界値のテスト**
   - 各世代の最初と最後のポケモンが正しく表示されることを確認
   - 第7世代: No.722 (モクロー) 〜 No.809 (メルメタル)
   - 第8世代: No.810 (サルノリ) 〜 No.905 (レジドラゴ)
   - 第9世代: No.906 (ニャオハ) 〜 No.1025 (ウガツホムラ)

4. **状態管理のテスト**
   - 世代切り替え時に選択中のポケモンがリセットされる
   - 世代切り替え時にリストがクリアされる
   - 世代切り替え時に検索用データがクリアされる

5. **UI動作のテスト**
   - ポップアップの開閉が正しく動作する
   - グリッド表示が正しく機能する
   - 選択中の世代が視覚的に識別できる
   - ポップアップ外クリックでポップアップが閉じる
   - 同じ世代を再選択しても無駄な処理が走らない
   - ローディング中は適切な表示がされる

## 実装手順

1. **型定義の拡張**
   - `Generation` 型を `1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 | 9` に変更

2. **世代設定の追加**
   - `GENERATION_CONFIG` に第7世代、第8世代、第9世代を追加

3. **状態管理の更新**
   - `isDropdownOpen` を `isPopupOpen` にリネーム

4. **ポップアップボタンの実装**
   - プルダウンをポップアップボタンに置き換え
   - トリガーボタンの実装
   - グリッドレイアウトで世代ボタンを3列表示
   - オーバーレイとポップアップ外クリックの処理

5. **必要なアイコンのimport**
   - `LayoutGrid` をlucide-reactからimport（既存のChevronDownをLayoutGridに変更）

6. **動作確認**
   - 各世代を選択して正しく切り替わるか確認
   - 世代ごとのポケモンIDが正しい範囲内か確認
   - データが混ざらないか確認

7. **型チェックとリント**
   - `npm run typecheck` を実行
   - `npm run lint` を実行

## 注意事項

- 世代切り替え時は必ず全データをクリアしてから新しいデータを取得
- `useEffect` の依存配列に `currentGeneration` を追加（既に実装済み）
- API呼び出しのoffsetは `startId - 1`（PokeAPIは0始まり）
- 既存の世代切り替えロジック（`handleGenerationChange`）はそのまま使用可能
- ポップアップは `z-index` を適切に設定し、他の要素の上に表示
- ポップアップ外クリックでポップアップを閉じる処理を実装
- エラーハンドリングを適切に実装
- ローディング状態を適切に管理

## 将来の拡張性

将来的に第10世代以降を追加する場合:
- `GENERATION_CONFIG` に新しい世代を追加
- `Generation` 型を拡張（`type Generation = 1 | 2 | ... | 10 | ...`）
- グリッドレイアウトは自動的に対応（4列目以降も表示可能）

## まとめ

この実装により：
- ユーザーは第1世代から第9世代までのポケモンをシームレスに切り替えられる
- ポップアップボタンにより、超省スペースで9つの選択肢を提供
- グリッドレイアウトで一覧性が高く、直感的に世代を選択できる
- 既存の世代切り替えロジックを活用し、データの混在を確実に防ぐ
- テストは厳格に行い、世代間でデータが混ざらないことを保証
- 第7世代から第9世代の新しいポケモンも正しく表示できる
